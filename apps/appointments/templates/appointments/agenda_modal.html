<form id="agenda-form-modal" action="{{ modal_url }}" method="post">
  {% csrf_token %}
  <div class="modal-header">
    <h5 class="modal-title d-inline-flex align-items-center">
      <span class="material-symbols-outlined me-2 text-primary">
        calendar_month
      </span>
      <span>
        Agenda
      </span>
    </h5>
    <button type="button" class="btn-close text-white" data-bs-dismiss="modal" aria-label="Close"></button>
  </div>
  <div class="modal-body">
    <section class="row">
      <section class="col-6 pr-0">
        <p class="mb-2 fs-6 text-primary">
          <b>Datos cita</b>
        </p>
        <div class="mb-2">
          <label for="{{ form.client.id_for_label }}" class="form-label form-label--custom">
            {{ form.client.label }}*
          </label>
          {{ form.client }}
          <span class="invalid-feedback invalid-feedback--custom {{ form.client.id_for_label }}">
            {{ form.client.errors.0 }}
          </span>
        </div>
        <div class="mb-2">
          <label for="{{ form.date_agenda.id_for_label }}" class="form-label form-label--custom">
            {{ form.date_agenda.label }}*
          </label>
          <div class="input-group">
            {{ form.date_agenda }}
            <div class="input-group-append">
              {{ form.time_agenda }}
            </div>
            <span class="invalid-feedback invalid-feedback--custom {{ form.date_agenda.id_for_label }}">
              {{ form.date_agenda.errors.0 }}
            </span>
            <span class="invalid-feedback invalid-feedback--custom {{ form.date_agenda.id_for_label }}">
              {{ form.time_agenda.errors.0 }}
            </span>
          </div>
        </div>
        <div class="mb-2">
          <label for="{{ form.observations.id_for_label }}" class="form-label form-label--custom">
            {{ form.observations.label }}
          </label>
          {{ form.observations }}
          <span class="invalid-feedback invalid-feedback--custom {{ form.observations.id_for_label }}">
            {{ form.observations.errors.0 }}
          </span>
        </div>
      </section>
      <section class="col-6 pl-0 border-start">
        <p class="mb-2 fs-6 text-primary">
          <b>Datos servicio</b>
        </p>
        <div class="mb-2">
          <label for="{{ form.service.id_for_label }}" class="form-label form-label--custom">
            {{ form.service.label }}*
          </label>
          {{ form.service }}
          <span class="invalid-feedback invalid-feedback--custom {{ form.service.id_for_label }}">
            {{ form.service.errors.0 }}
          </span>
          <p class="m-0 mt-1 form-label form-label--custom"><b>Tiempo estimado:</b> <span id="service-duration">0</span>
            minutos</p>
        </div>
        <div class="pricing-receipt">
          <div class="pricing-receipt-content">
            <div class="pricing-receipt-row pricing-receipt-service">
              <span class="pricing-receipt-label">Precio</span>
              <span id="service-price" class="pricing-receipt-price">$ 0</span>
            </div>
            <div class="pricing-receipt-discount-section">
              <label for="{{ form.discount_amount.id_for_label }}" class="pricing-receipt-label">
                {{ form.discount_amount.label }}
              </label>
              <div class="pricing-receipt-input-wrapper">
                <span class="pricing-receipt-currency">-$</span>
                {{ form.discount_amount }}
              </div>
            </div>
            <div class="pricing-receipt-row pricing-receipt-total">
              <span class="pricing-receipt-total-label">Total</span>
              <span id="total-amount" class="pricing-receipt-total-amount">$ 0</span>
            </div>
          </div>
        </div>
      </section>
    </section>
    <section class="my-3 d-flex align-items-center justify-content-end">
      <button id="add-service-btn" type="button" class="btn btn-sm btn-success bg-gradient" disabled>
        <span class="material-symbols-outlined fs-6">
          add_circle
        </span>
        AÃ±adir servicio
      </button>
    </section>
    <section class="accordion" id="accordionAgendaServices">
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
            data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
            Accordion Item #2
          </button>
        </h2>
        <div id="collapseTwo" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
          <div class="accordion-body">
            <strong>This is the second item accordion body.</strong> It is hidden by default, until the collapse
            plugin adds the appropriate classes that we use to style each element. These classes control the overall
            appearance, as well as the showing and hiding via CSS transitions. You can modify any of this with custom
            CSS or overriding our default variables. It also worth noting that just about any HTML can go within the
            <code>.accordion-body</code>, though the transition does limit overflow.
          </div>
        </div>
      </div>
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
            data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
            Accordion Item #2
          </button>
        </h2>
        <div id="collapseTwo" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
          <div class="accordion-body">
            <strong>This is the second item accordion body.</strong> It is hidden by default, until the collapse
            plugin adds the appropriate classes that we use to style each element. These classes control the overall
            appearance, as well as the showing and hiding via CSS transitions. You can modify any of this with custom
            CSS or overriding our default variables. It also worth noting that just about any HTML can go within the
            <code>.accordion-body</code>, though the transition does limit overflow.
          </div>
        </div>
      </div>
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
            data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
            Accordion Item #2
          </button>
        </h2>
        <div id="collapseTwo" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
          <div class="accordion-body">
            <strong>This is the second item accordion body.</strong> It is hidden by default, until the collapse
            plugin adds the appropriate classes that we use to style each element. These classes control the overall
            appearance, as well as the showing and hiding via CSS transitions. You can modify any of this with custom
            CSS or overriding our default variables. It also worth noting that just about any HTML can go within the
            <code>.accordion-body</code>, though the transition does limit overflow.
          </div>
        </div>
      </div>
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
            data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
            Accordion Item #2
          </button>
        </h2>
        <div id="collapseTwo" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
          <div class="accordion-body">
            <strong>This is the second item accordion body.</strong> It is hidden by default, until the collapse
            plugin adds the appropriate classes that we use to style each element. These classes control the overall
            appearance, as well as the showing and hiding via CSS transitions. You can modify any of this with custom
            CSS or overriding our default variables. It also worth noting that just about any HTML can go within the
            <code>.accordion-body</code>, though the transition does limit overflow.
          </div>
        </div>
      </div>
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
            data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
            Accordion Item #2
          </button>
        </h2>
        <div id="collapseTwo" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
          <div class="accordion-body">
            <strong>This is the second item accordion body.</strong> It is hidden by default, until the collapse
            plugin adds the appropriate classes that we use to style each element. These classes control the overall
            appearance, as well as the showing and hiding via CSS transitions. You can modify any of this with custom
            CSS or overriding our default variables. It also worth noting that just about any HTML can go within the
            <code>.accordion-body</code>, though the transition does limit overflow.
          </div>
        </div>
      </div>
    </section>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-sm btn-danger bg-gradient me-2" data-bs-dismiss="modal">
      Cancelar
    </button>
    <button id="agenda_submit_btn" type="button" class="btn btn-sm btn-primary bg-gradient">
      Guardar
    </button>
  </div>
</form>
{% block extra_js %}
<script>
  $(() => {
    initializeDatePickers();
    const servicesSet = new Set();
    const agendaSet = new Set();

    const getServicePrice = () => {
      let servicePrice = 0;
      servicesSet.forEach(({ precio }) => {
        servicePrice = precio || 0;
      });
      return servicePrice;
    }

    const handlerPricingReceipt = () => {
      if (!servicesSet.size) return;
      const discountAmount = parseInt($('#{{ form.discount_amount.id_for_label }}').val()) || 0;
      const servicePrice = getServicePrice();
      const totalAmount = (parseInt(servicePrice, 10) || 0) - discountAmount;
      $('#service-price').text(`$ ${servicePrice}`);
      $('#total-amount').text(`$ ${totalAmount}`);
    }

    $('#{{ form.discount_amount.id_for_label }}').change((e) => {
      if (!servicesSet.size) return;
      const discountAmount = parseInt($(e.currentTarget).val()) || 0;
      const servicePrice = getServicePrice();
      const totalAmount = servicePrice - discountAmount;
      $('#total-amount').text(`$ ${totalAmount}`);
    });

    const handlerService = async (serviceID) => {
      const url = "{% url 'service_details_ajax' %}";
      const data = { service_id: serviceID };
      const [response = {}, status] = await getResponseToRequest(url, data, "GET");
      servicesSet.clear();
      servicesSet.add({ ...response });
      const { duracion_estimada = 0 } = response;
      handlerPricingReceipt();
      $('#service-duration').text(duracion_estimada);
      if ([500].includes(status)) {
        notifyAlert(response, status);
      }
    }

    const resetPricingReceipt = () => {
      $('#service-price').text(`$ 0`);
      $('#total-amount').text(`$ 0`);
      $('#service-duration').text(`0`);
      $('#{{ form.discount_amount.id_for_label }}').val('0');
      servicesSet.clear();
    }

    $('#{{ form.service.id_for_label }}').on('change', (e) => {
      const serviceID = $(e.currentTarget).val();
      if (serviceID) {
        handlerService(serviceID);
        return;
      }
      resetPricingReceipt();
    });

    const fieldRequiredList = [
      '#{{ form.client.id_for_label }}',
      '#{{ form.service.id_for_label }}',
      '#{{ form.date_agenda.id_for_label }}',
      '#{{ form.time_agenda.id_for_label }}'
    ];
    $(fieldRequiredList.join(',')).on('change', ({ target }) => {
      const areFieldsFilled = fieldRequiredList.every((fieldSelector) => {
        const fieldValue = $(fieldSelector).val();
        return fieldValue && fieldValue.trim() !== '';
      });
      $('#add-service-btn').prop('disabled', !areFieldsFilled);
    });

    $('#add-service-btn').click(() => {
      const getClientData = () => {
        const clientID = $('#{{ form.client.id_for_label }}').val();
        const clientName = $('#{{ form.client.id_for_label }} option:selected').text();
        return { idCliente: clientID, nombreCliente: clientName };
      }
      const getServiceData = () => {
        const service = {};
        const serviceDiscount = parseInt($('#{{ form.discount_amount.id_for_label }}').val()) || 0;
        servicesSet.forEach((serviceData) => {
          const { precio } = serviceData;
          const total = (precio || 0) - serviceDiscount;
          const serviceDate = $('#{{ form.date_agenda.id_for_label }}').val();
          const serviceTime = $('#{{ form.time_agenda.id_for_label }}').val();
          const observations = $('#{{ form.observations.id_for_label }}').val();
          Object.assign(service, { ...serviceData, total, descuento: serviceDiscount, fecha: serviceDate, hora: serviceTime, observaciones: observations });
        });
        return service;
      }

      const serviceData = getServiceData();
      const clientData = getClientData();

      if (!agendaSet.size) {
        agendaSet.add({ ...clientData, servicios: [serviceData] });
        return;
      }
      const { idCliente: clientID } = clientData;
      let found = false;
      for (const agenda of agendaSet) {
        if (agenda.idCliente === clientID) {
          agenda.servicios.push(serviceData);
          found = true;
          break;
        }
      }
      if (!found) {
        agendaSet.add({ ...clientData, servicios: [serviceData] });
      }
      console.log(agendaSet);
    });

  });
</script>
{% endblock %}