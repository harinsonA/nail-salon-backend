{% extends 'base.html' %}

{% block view_title %}
Lista de clientes
{% endblock %}

{% block content %}
{% include 'bs_modal.html' %}
<section>
  <section>
    <a id="client-create-btn" data-form-url="{%  url 'client_create_modal' %}"
      class="btn btn-primary btn-sm d-inline-flex align-items-center gap-2" role="button">
      Cliente
      <span class="material-symbols-outlined">
        add
      </span>
    </a>
  </section>
  <section class="mt-3 d-inline-block">
    <div>
      <label class="form-check-label form-label--custom" for="{{ filter_form.status.id_for_label }}">
        {{ filter_form.status.label }}
      </label>
      {{ filter_form.status }}
    </div>
  </section>
  <section class="table-container--custom">
    <table id="client_table" class="table table-hover ">
      <thead>
        <tr>
          <th scope="col">Nombre</th>
          <th scope="col">Estado</th>
          <th scope="col">Tel√©fono</th>
          <th scope="col">Correo</th>
          <th scope="col"></th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
  </section>
</section>
{% endblock %}
{% block extra_js %}
<script>
  $(() => {
    const statusColumn = (status) => status ? `
      <span class="material-symbols-outlined text-success">
        check_circle
      </span>` : `
      <span class="material-symbols-outlined text-danger">
        cancel
      </span>`;

    const filterData = {
      status: $('#{{ filter_form.status.id_for_label }}').val(),
    };
    const dataTableConfig = {
      tableID: '#client_table',
      url: '{{ url_client_list }}',
      requestData: filterData,
      columns: [
        { data: 'full_name', className: 'fs-7 w-auto text-nowrap' },
        { data: ({ activo }) => statusColumn(activo), className: 'fs-7 w-auto text-center' },
        { data: 'telefono', className: 'fs-7 w-auto text-center' },
        { data: 'email', className: 'fs-7 w-auto' },
        { data: ({ options }) => optionsColumn(options), className: 'all fs-7 w-auto text-center', orderable: false, searchable: false },
      ],
      extraConfig: {
        drawCallback: () => {
          initializeAllBSModals();
        },
      },
    };

    const table = renderDataTable(dataTableConfig);
    $('#{{ filter_form.status.id_for_label }}').on('change', ({ target }) => {
      filterData.status = target.value;
      table.draw()
    });

    initializeBSModals('#client-create-btn');
    $('#modal').on('show.bs.modal', ({ target }) => {
      const submitBtn = target.querySelector('#client_submit_btn') || target.querySelector('#delete_submit_btn');
      $(submitBtn).click(async () => {
        submitBtn.disabled = true;
        const modalForm = target.querySelector('#client-form-modal') || target.querySelector('#common-form-modal');
        const reloadTable = (form, response, statusCode) => {
          if ([200].includes(statusCode)) {
            $('#modal').modal('hide');
            table.draw();
          }
          submitBtn.disabled = statusCode === 200;
          return [response, statusCode];
        };
        const [response, statusCode] = await submitRequestBSModal(modalForm, false, reloadTable);
      });
    });

  });
</script>
{% endblock %}